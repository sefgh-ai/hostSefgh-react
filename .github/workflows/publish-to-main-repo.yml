name: Publish React Build Output to Main Repo Root

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Smart install dependencies
        run: |
          set -e
          if [ -f package-lock.json ]; then
            echo "Trying npm ci..."
            npm ci || {
              echo "npm ci failed, trying npm install --legacy-peer-deps..."
              npm install --legacy-peer-deps || {
                echo "npm install --legacy-peer-deps failed, trying npm install --force..."
                npm install --force || {
                  echo "All npm install attempts failed!"; exit 1;
                }
              }
            }
          else
            echo "No package-lock.json, trying npm install..."
            npm install --legacy-peer-deps || {
              echo "npm install --legacy-peer-deps failed, trying npm install --force..."
              npm install --force || {
                echo "All npm install attempts failed!"; exit 1;
              }
            }
          fi

      - name: Smart build (with fallback)
        id: buildstep
        run: |
          # Try multiple build approaches for resilience
          set -e
          export NODE_OPTIONS=--max_old_space_size=4096
          echo "Standard build attempt..."
          if npm run build; then
            echo "Standard build succeeded"
          else
            echo "Standard build failed, attempting esbuild rebuild..."
            npm rebuild esbuild || true
            if npm run build; then
              echo "Build succeeded after esbuild rebuild"
            else
              echo "Build failed after esbuild rebuild, attempting with latest esbuild..."
              npm install esbuild@latest --no-save || true
              if npm run build; then
                echo "Build succeeded after installing latest esbuild"
              else
                echo "All build attempts failed!"
                exit 1
              fi
            fi
          fi

      - name: List files after build (diagnostic)
        run: |
          echo "Files after build:"
          find . -maxdepth 2

      - name: Identify build output directory
        id: find-output
        run: |
          if [ -d "dist" ]; then
            echo "output_dir=dist" >> $GITHUB_OUTPUT
            echo "Build output found in dist directory"
          elif [ -d "build" ]; then
            echo "output_dir=build" >> $GITHUB_OUTPUT
            echo "Build output found in build directory"
          else
            OUTPUT_DIR=$(find . -maxdepth 1 -type d ! -name "node_modules" ! -name ".git" ! -name "." | head -n 1 | sed 's|^\./||')
            if [ -n "$OUTPUT_DIR" ]; then
              echo "output_dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
              echo "Fallback: Build output found in $OUTPUT_DIR directory"
            else
              echo "No build output directory found"
              exit 1
            fi
          fi

      - name: Clone Main Repo
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git clone https://github.com/sefgh-ai/hostSefgh.git ../main-repo
          cd ../main-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Copy build output to main repo root and rename index.html
        run: |
          cd ../main-repo
          cp -rf ../hostSefgh-react/${{ steps.find-output.outputs.output_dir }}/* .
          if [ -f ./index.html ]; then
            mv ./index.html ./searchpage.html
          fi

      - name: Commit and Push to Main Repo
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd ../main-repo
          git add .
          git commit -m "Publish React build to root (auto, ${{ github.sha }})" || echo "No changes to commit"
          git push https://x-access-token:${GH_TOKEN}@github.com/sefgh-ai/hostSefgh.git main
